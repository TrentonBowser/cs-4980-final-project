---
title: "Chicago Crime Prediction"
output:
  html_document:
    df_print: paged
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*.

Also *Ctrl+Enter* runs just the line you are on.

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

```{r}
library(tidyverse)
library(dplyr)
library(lubridate)
```


## Data Loading

```{r}
crime_data <- read_csv(
  "data/chicago-crime-dataset.csv",
  col_names = TRUE,
  locale = locale("en", tz="US/Central"),
  na = c("", "NA"),
  skip_empty_rows = TRUE,
  show_col_types = FALSE,
)

weather_data <- read_csv(
  "data/noaa-chicago-weather.csv",
  col_names = TRUE,
  locale = locale("en", tz="US/Central"),
  na = c("", "NA"),
  skip_empty_rows = TRUE,
  show_col_types = FALSE,
)

parks_data <- read_csv(
  "data/chicago-parks-data.csv",
  col_names = TRUE,
  locale = locale("en", tz="US/Central"),
  na = c("", "NA"),
  skip_empty_rows = TRUE,
  show_col_types = FALSE,
)
```


## Initial Data Cleaning
```{r}
cleaned_weather_data <- select(weather_data, -c(STATION, NAME, LATITUDE, LONGITUDE, ELEVATION))
cleaned_weather_data$DATE <- mdy(cleaned_weather_data$DATE)
cleaned_weather_data <- rename(cleaned_weather_data, Date = DATE)
```

```{r}
cleaned_crime_data <- select(crime_data, -c(ID,'Case Number' , Block, 'X Coordinate', 'Y Coordinate', Year, 'Updated On', Location))
cleaned_crime_data$DateTime <- mdy_hms(cleaned_crime_data$Date)
cleaned_crime_data$Date <- date(cleaned_crime_data$DateTime)
```

```{r}
cleaned_parks_data <- select(parks_data, -c(OBJECTID, the_geom, GISOBJID))
cleaned_parks_data <- rename(cleaned_parks_data, Longitude = X_COORD, Latitude = Y_COORD)
```



## Combining Data
```{r}
combined_data <- cleaned_crime_data %>% left_join(cleaned_weather_data, by="Date")
combined_data <- select(combined_data, -Date)

# Cleaning up previous data sets in environment
rm(crime_data)
rm(weather_data)
rm(cleaned_weather_data)
rm(cleaned_crime_data)
rm(parks_data)
```



## Adding Nearest Park To Crime
```{r}
park_locations <-cleaned_parks_data %>%
  group_by(PARK_NO) %>%
  summarize_at(vars(Longitude:Latitude), mean)

# Function to calculate the distance between two latitude and longitude values (Haversine Formula)
calculate_distance <- function(row, lat1, long1){
  radius <- 3958.8
  d_lat <- abs(lat1-as.numeric(row["Latitude"])) * pi / 180.0
  d_long <- abs(long1-as.numeric(row["Longitude"])) * pi / 180.0
  
  temp1 <- (sin(d_lat/2.0) * sin(d_lat/2.0)) +
    ((cos(lat1*pi/180.0) * cos(as.numeric(row["Latitude"])*pi/180.0)) *
    (sin(d_long/2.0) * sin(d_long/2.0)))
  temp2 <- 2 * atan2(sqrt(temp1), sqrt(1.0-temp1))
  return(temp2*radius)
}

# Function that finds the closest park and its distance from each crime row
get_closest_park_function <- function(row){
  park_distances <- apply(park_locations, MARGIN=1, FUN=calculate_distance, lat1=as.numeric(row["Latitude"]), long1=as.numeric(row["Longitude"]))
  closest_park_index <- which.min(park_distances)
  
  closest_dist <- park_distances[closest_park_index]
  closest_park <- (park_locations %>% slice(closest_park_index))$PARK_NO
  return(c(closest_park, closest_dist))
}

closest_parks <- apply(combined_data, MARGIN=1, FUN=get_closest_park_function)


#combined_data %>% slice(2)
```


















